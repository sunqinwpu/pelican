 Title: Redos
 Date: 2016-08-14 00:00:00
 Modified: 2016-08-14 00:00:00
 Category: Technology
 Tags: 正则表达式，Redos
 Slug: redos
 Summary: 正则表达式是个好东西，灵活且功能强大。然而，用得好，就是神兵利器。用不好，就是定时炸弹。
 
谈谈【Redos】

##### 缘起
周六的晚上，正在家过休闲的周末，突然公司应急响应群，开始热闹起来。线上多台服务机器CPU持续飙高。到线上机器jstack dump系统线程发现，线程全卡在java.util.regex.Pattern.*的方法中。立刻意识到，应该是某个合作方的正则表达式，配置的有性能问题，导致方法调用CPU飙高。

正则表达式是个好东西，灵活且功能强大。然而，用得好，就是神兵利器。用不好，就是定时炸弹。

##### 何为Redos ？
The Regular expression Denial of Service (ReDoS)是拒绝服务攻击的一种。攻击者利用正则表达式的执行漏洞,通过构造特定输入，使正则表达式执行时间，随着输入的长度，呈指数级增长,最终，耗尽系统资源，造成系统不可用。

##### 根源
从本质上讲，存在两种不同类型的正则表达式引擎：确定性有限状态机(deterministic finite-state automaton DFA)和非确定性有限状态机(nondeterministic finite automaton NFA) 引擎。关于两种引擎的具体详情在此不展开。

Java正则表达式引擎是NFA引擎，NFA引擎是回溯引擎，NFA引擎与DFA引擎的最大不同是，DFA引擎对字符串中的每个字符最多计算一次，NFA引擎可以对输入字符串中的每个字符计算多次。回溯方法有诸多优势，可以处理包含后向引用活捕获括号的正则表达式，缺点就是处理时间大大超过DFA。

##### 例子
- 普通正则表达式【^\d+$】 

	以【^\d+$】为例子，用于判断以数字开头和结尾的字符串。假如我们用123456X作为输入来测试。计算步骤从头开发，发现字符1是有效字符，然后移动到字符2，发现字符串12匹配，再移动到字符3(尝试匹配123)，以此类推，直到X发现不匹配。
	 
	而是从其当前的匹配 (123456) 返回到其上一个已知的匹配 (12345)，然后从那里再次尝试匹配。由于 5 后面的下一个字符不是此字符串的结尾，因此，此正则表达式不是匹配项，它会返回到其上一个已知的匹配 (1234)，然后再次尝试匹配。按这种方式进行所有匹配，直到此引擎返回到其第一个匹配 (1)，发现 1 后面的字符不是此字符串的结尾。此时，正则表达式停止，没有找到任何匹配。


	总的说来，此引擎计算了六个路径：123456、12345、1234、123、12 和 1。如果此输入字符串再增加一个字符，则引擎会多计算一个路径。因此，此正则表达式是相对于字符串长度的线性算法，不存在导致 DoS 的风险。

- 带捕获的正则表达式【^(\d)+$】
	
	这并不能从根本上改变这些计算的结果；它只是让开发人员获得任何作为捕获组的匹配。在此情况下，添加分组括号也不能从根本上改变此表达式的执行速度。针对输入 123456X 测试此模式仍然会导致此引擎仅计算六种不同的路径。
- DeDos正则表达式【^(\d+)+$】

	分组表达式 (\d+) 后面额外的 + 字符表明此正则表达式引擎可匹配任何数量的捕获组。此引擎按以前的方式进行计算，在到达 123456 之后回溯到 12345。

	这就是关键所在（因为存在非常可怕的危险）。此引擎不仅会检查到 5 后面的下一个字符不是此字符串的结尾，而且还会将下一个字符 6 作为新的捕获组，并从那里开始重新检查。一旦此途径失败，它会返回到 1234，将 56 作为单独的捕获组，然后将 5 和 6 分别作为单独的捕获组。最终结果是该引擎实际上完成了 32 个不同路径的计算。

	现在，我们只要向此计算字符串再增加一个数字字符，该引擎将必须计算 64 个路径（翻了一倍）才能确定它不是匹配项。这会使正则表达式引擎执行的工作量呈指数增加。攻击者只要提供相对较短的输入字符串（30 个字符左右）就可强制引擎处理数亿个路径，所需时间多达几小时或几天。

- 更多有问题的正则表达式
<pre><code>^(\d+)*$
	 ^(\d*)*$
	 ^(\d+|\s+)*$ 
	 ^([0-9a-zA-Z]([-.\w]*[0-9a-zA-Z])*@(([0-9a-zA-Z])+([-\w]*[0-9a-zA-Z])*\.)+[a-zA-Z]{2,9})$
</code></pre>

##### 预防措施
- 减少正则表达式使用 

	不是所有的场景都需要使用正则表达式这种工具，很多时候，都是杀鸡使用了牛刀。 对提供Sass服务的企业，更不能开放给客户编写正则表达式的权利，不然，分分钟搞死自己。 
	
- 前置校验 

	可以在进入正则表达式校验之前，先进行长度校验，特定字符校验等等。 比如，校验手机号的正则，完全可以先限制长度，不给攻击者可乘之机。
	
- 深入理解正则表达式 

	很多人写正则表达式，包括我自己，都是网上找找资料，随便写写，跑通之后，就开心大吉。这样做事，迟早要出问题。要做到知其然，知其所以然。
	
- 详细测试
	
	意识到正则表达式的潜在风险，对正则表达式用各种组合来进行性能测试。
	
- 防止代码泄露 
	
	代码如果一旦泄露，黑客就可以分析系统中的正则表达式。所谓百密一疏，难免会有几个有问题的，相当于给了黑客定向攻击的机会。

##### 相关连接
- [正则表达式30分钟入门](http://deerchao.net/tutorials/regex/regex.htm)
- [Redos](https://www.owasp.org/index.php/Regular_expression_Denial_of_Service_-_ReDoS)
- [正则表达式拒绝服务攻击和防御](https://msdn.microsoft.com/zh-cn/magazine/ff646973.aspx)

