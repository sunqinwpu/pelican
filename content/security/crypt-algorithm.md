Title: 加密算法!
Date: 2016-08-12
Modified: 2016-08-12
Category: Security
Tags: 加密算法，摘要算法，对称加密，非对称加密
Slug: crypt-algorithms
Summary: 对常见的加密算法，实现、性能、安全性、应用场景做一个说明和对比

##### 我们面临的问题
- 如何存储网站用户名和密码？
- 如何在登陆的时候，做用户名和密码校验?
- 如何加密你的文件，保证安全性?
- 如何确定，你访问的网站是真实的？
- 如何保证传输数据的完整性、可靠性、保密性、不可抵赖性?

通过如下的加解密算法的简单说明，能间接地地回答这些问题。

##### 消息摘要算法
消息摘要算法包括MD(Message Digest 消息摘要算法)，SHA(Secure Hash Algorithm 安全散列算法)和MAC(Message authentication code消息验证码)三个系列。主要用于验证数据的完整性，密码加密等领域。
###### MD系列算法 
MD系列算法包括MD,MD2,MD3,MD4,MD5。是一个不断优化改进的过程。MD5是输入不定长信息，输出固定长度128-bits的算法。基本方式为，求余、取余、调整长度、与链接变量进行循环运算。经过程序流程，生成四个32位数据，最后联合起来成为一个128-bits散列。

- 性能很好。
- 安全性。
	- MD5会产生Hash碰撞，不适用于SSL证书，数字签章。
    - 彩虹表反查，可以轻松破解。
    - 加salt之后，会乐观点，取决于salt的长度。某些网站，轻松使用大数据，上百TB的硬盘，存储了大量组合的MD5值。
    
最好不要在密码校验的场景使用MD5。目前只适合校验数据完整性。不过，国内顶级互联网公司的密码，也有很多都是MD5存储，且不加salt，当然这有历史原因。

###### SHA系列算法
SHA系列包括五个算法，分别是SHA-1、SHA-224、SHA-256、SHA-384，和SHA-512,后4中并称为SHA2。
SHA是FIPS所认证的五种安全散列算法。这些算法之所以称作“安全”是基于以下两点（根据官方标准的描述）：

- 由消息摘要反推原输入消息，从计算理论上来说是很困难的。
- 想要找到两组不同的消息对应到相同的消息摘要，从计算理论上来说也是很困难的。任何对输入消息的变动，都有很高的概率导致其产生的消息摘要迥异。
SHA-1应用在很多安全领域，曾被视为MD5的后继者，不过现在安全性受到严重质疑。目前为止尚无对SHA2的有效攻击，不过SHA2的算法和HSA1基本相似。

###### MAC
MAC与MD和SHA不同，MAC是含有密钥的散列函数算法，我们也常把MAC称为HMAC。

- HMAC. HMAC是密钥相关的哈希运算消息认证码（Hash-based Message Authentication Code）,HMAC运算利用哈希算法，以一个密钥和一个消息为输入，生成一个消息摘要作为输出。
	- HMAC的一个典型应用是用在“挑战/响应”（Challenge/Response）身份认证中。
  

###### 慢Hash函数
一般网站在存储用户密码的时候，使用上述的散列算法进行散列后存储，在用户登录的时候，对用户输入的密码做散列，然后对比验证。如果网站密码泄露，被黑客获取，通过彩虹表可以轻松破解。为了应对破解的问题，有了3种新的慢Hash函数，所谓慢Hash，就是让签名的过程变得很慢，需要消耗更多地cpu和内存，使黑客建立彩虹表的成本变高。目前主要有三种bcrypt,scrypt,PBKDF2。

- PBKDF2(Password-Based Key Derivation Function)。PBKDF2简单而言就是将salted hash进行多次重复计算，这个次数是可选择的。如果计算一次所需要的时间是1微秒，那么计算1百万次就需要1秒钟。假如攻击一个密码所需的rainbow table有1千万条，建立所对应的rainbow table所需要的时间就是115天。这个代价足以让大部分的攻击者忘而生畏。
- bcrypt。bcrypt是专门为密码存储而设计的算法，基于Blowfish加密算法变形而来，由Niels Provos和David Mazières发表于1999年的USENIX。
bcrypt最大的好处是有一个参数（work factor)，可用于调整计算强度，而且work factor是包括在输出的摘要中的。随着攻击者计算能力的提高，使用者可以逐步增大work factor，而且不会影响已有用户的登陆。
bcrypt经过了很多安全专家的仔细分析，使用在以安全著称的OpenBSD中，一般认为它比PBKDF2更能承受随着计算能力加强而带来的风险。bcrypt也有广泛的函数库支持，因此使用这种方式存储密码会更安全。
- scrypt。scrypt是由著名的FreeBSD黑客 Colin Percival为他的备份服务 Tarsnap开发的。
和上述两种方案不同，scrypt不仅计算所需时间长，而且占用的内存也多，使得并行计算多个摘要异常困难，因此利用rainbow table进行暴力攻击更加困难。scrypt没有在生产环境中大规模应用，并且缺乏仔细的审察和广泛的函数库支持。但是，scrypt在算法层面只要没有破绽，它的安全性应该高于PBKDF2和bcrypt。

消息摘要算法是不可逆的，只能用于校验数据。在数据传输中，若想通过密文，加密出原文，就需要对称加密和非对称加密算法来解决。

##### 对称加密算法:
基于“对称密钥”的加密算法主要有DES、3DES（TripleDES）、AES、RC2、RC4、RC5和Blowfish等。
对称加密算法的特点是：

- 算法公开
- 计算量小
- 加密速度快

常用的算法主要包括DES、3DES（TripleDES）和AES，其中DES已经非常不安全，不建议使用。对称加密算法通常就是将数据按位组合，置换，迭代运算，最后得到密文，解密过程相反。需要注意的是，分组模式和填充方式，对结果和安全性有一定的影响。

- 分组模式 分组模式主要是影响密码和明文数据库的计算方式，常用的有

	-  EBC
	-  CBC
	-  CFB
	-  OFB
	-  CTR
	
- 填充 加密过程是对一串固定位数的数据加密(DES是64位，AES是128位)，当数据位数不足时，就需要填充数据，来完成后续的计算。 常用的有:

	- NoPadding（不填充）
	- Zeros填充（0填充）就是在后面补0.
	- PKCS5Padding 少几个数，就补几个几。
	
##### 非对称加密算法
对称加密需要交换秘钥，而秘钥交换，本身就是个很不安全，很麻烦的事情。非对称加密克服了这个问题，不过性能相对要差很多。对非对称加密而言，有公钥和私钥，公钥加密，私钥解密，反之亦然。使用者生成公私钥，把公钥公开出去，私钥保留，就可以完成加密通信，且私钥无需传输，安全性更高。
###### 常用非对称加密算法
常用的非对称加密算法有：

- RSA
- Elgamal
- 背包算法
- Rabin
- D-H
- ECC
其中RSA应用最为广泛，现在主流的证书体系，基本都是依靠RSA非对称加密。非对称加密是Https的基石。

###### Https协议
由于Http协议是明文传输，所以安全性无法保障。Https在Http协议的基础上引入SSL协议。
HTTPS和HTTP的区别主要为以下四点：

- https协议需要到CA申请证书，一般免费证书很少，需要交费。
- http是超文本传输协议，信息是明文传输，https 则是具有安全性的ssl加密传输协议。
- http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。
- http的连接很简单，是无状态的；HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，比http协议安全。

###### 证书系统
- 数字证书为实现双方安全通信提供电子认证。在因特网、公司内部网或外部网中，使用数字证书实现身份识别和电子信息加密。数字证书中含有密钥对（公钥和私钥）所有者的识别信息，通过验证识别信息的真伪实现对证书持有者身份的认证。
-  Let's Encrypt旨在简化Https证书申请流程，让证书申请，管理变得非常容易。我的个人blog [libereco.cn](https://libereco.cn)就是通过Let's Encrypt申请的证书。
- Diffie–Hellman key exchange。 这是个很有趣的数学问题，之所以说，数学是一切学科的基础，果然是很有道理的。

##### OPENSSL
OpenSSL 是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及SSL协议，并提供丰富的应用程序供测试或其它目的使用。

以上是对加解密的一些总结，因为在这个领域专攻时间尚短，理解确实比较粗浅，写的不好。

*写这个总结才发现，综述性质的文章是最难写的，需要很广很深的积淀*。

预告：昨天晚上公司完成了杭州机房->上海机房的切换。 之后我会写一篇Sass服务公司多机房部署的文章，来聊聊多机房架构的问题。

相关链接

- [HMAC](http://en.wikipedia.org/wiki/Hash-based_message_authentication_code)
- [PBKDF2](http://en.wikipedia.org/wiki/PBKDF2)
- [Let's Encrypt](https://letsencrypt.org/)
- [Java C# AES ](https://zenu.wordpress.com/2011/09/21/aes-128bit-cross-platform-java-and-c-encryption-compatibility/)
- [OPENSSL](https://www.openssl.org/)
- [Https]（https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE）
- [Https的7个误解](http://www.ruanyifeng.com/blog/2011/02/seven_myths_about_https.html)